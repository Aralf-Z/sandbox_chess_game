using System;
using System.Collections.Generic;

namespace FastGameDev.Math
{
    /// <summary>
    /// PRD随机分布
    /// </summary>
    public class PseudoRandomDistribution
    {
        private int mCIndex = 0;
        private int mNValue = 0;
        private readonly Random mRandom;
        
        public PseudoRandomDistribution()
        {
            mRandom =  new Random();
        }

        public PseudoRandomDistribution(int seed)
        {
            mRandom = new Random(seed);
        }
        
        public void Reset()
        {
            mCIndex = 0;
            mNValue = 0;
        }
        
        /// <summary>
        /// 
        /// </summary>
        /// <param name="probability">0-100</param>
        /// <returns></returns>
        public bool Do(int probability)
        {
            if (probability != mCIndex)
            {
                mCIndex = probability;
                mNValue = 0;
            }

            var p = CValue.Get(probability) * ++mNValue;
            var isHappened = p >= mRandom.NextDouble();
            mNValue = isHappened ? 0 : mNValue;

            return isHappened;
        }

        private static class CValue
        {
            private static readonly Dictionary<int, float> Map = new Dictionary<int, float>()
            {
                [0]   = 0f,
                [1]   = 0.00061767578125f,
                [2]   = 0.001387939453125f,
                [3]   = 0.0024462890625f,
                [4]   = 0.003802490234375f,
                [5]   = 0.00544189453125f,
                [6]   = 0.007357177734375f,
                [7]   = 0.009560546875f,
                [8]   = 0.012008056640625f,
                [9]   = 0.01473388671875f,
                [10]  = 0.017738037109375f,
                [11]  = 0.0209912109375f,
                [12]  = 0.024486083984375f,
                [13]  = 0.02821533203125f,
                [14]  = 0.032208251953125f,
                [15]  = 0.03646484375f,
                [16]  = 0.03646484375f,
                [17]  = 0.04563720703125f,
                [18]  = 0.050538330078125f,
                [19]  = 0.0556884765625f,
                [20]  = 0.061087646484375f,
                [21]  = 0.06668212890625f,
                [22]  = 0.072464599609375f,
                [23]  = 0.078486328125f,
                [24]  = 0.084747314453125f,
                [25]  = 0.09118408203125f,
                [26]  = 0.097855224609375f,
                [27]  = 0.1046923828125f,
                [28]  = 0.111688232421875f,
                [29]  = 0.11898193359375f,
                [30]  = 0.126372680664062f,
                [31]  = 0.13400390625f,
                [32]  = 0.141817016601562f,
                [33]  = 0.149808349609375f,
                [34]  = 0.157974243164063f,
                [35]  = 0.16631103515625f,
                [36]  = 0.174905395507812f,
                [37]  = 0.183621826171875f,
                [38]  = 0.192500610351562f,
                [39]  = 0.2015380859375f,
                [40]  = 0.210930786132812f,
                [41]  = 0.220382080078125f,
                [42]  = 0.229880981445313f,
                [43]  = 0.23952392578125f,
                [44]  = 0.249307250976562f,
                [45]  = 0.259844970703125f,
                [46]  = 0.270427856445313f,
                [47]  = 0.280986328125f,
                [48]  = 0.291565551757813f,
                [49]  = 0.302093505859375f,
                [50]  = 0.312680053710937f,
                [51]  = 0.32331787109375f,
                [52]  = 0.334161376953125f,
                [53]  = 0.347354736328125f,
                [54]  = 0.360366821289063f,
                [55]  = 0.3732080078125f,
                [56]  = 0.385856323242187f,
                [57]  = 0.398289794921875f,
                [58]  = 0.410558471679688f,
                [59]  = 0.42264404296875f,
                [60]  = 0.434602661132813f,
                [61]  = 0.446419677734375f,
                [62]  = 0.458080444335938f,
                [63]  = 0.4696484375f,
                [64]  = 0.481112670898438f,
                [65]  = 0.492462158203125f,
                [66]  = 0.507489013671875f,
                [67]  = 0.5293408203125f,
                [68]  = 0.550770263671875f,
                [69]  = 0.57139892578125f,
                [70]  = 0.591522216796875f,
                [71]  = 0.611103515625f,
                [72]  = 0.630106201171875f,
                [73]  = 0.64867431640625f,
                [74]  = 0.666641235351563f,
                [75]  = 0.68425048828125f,
                [76]  = 0.701337280273438f,
                [77]  = 0.717967529296875f,
                [78]  = 0.734212036132813f,
                [79]  = 0.750048828125f,
                [80]  = 0.765455932617187f,
                [81]  = 0.780511474609375f,
                [82]  = 0.795197143554687f,
                [83]  = 0.80949462890625f,
                [84]  = 0.823489379882813f,
                [85]  = 0.837166748046875f,
                [86]  = 0.850618286132813f,
                [87]  = 0.8636181640625f,
                [88]  = 0.876365356445313f,
                [89]  = 0.888848876953125f,
                [90]  = 0.901057739257813f,
                [91]  = 0.91309326171875f,
                [92]  = 0.924721069335938f,
                [93]  = 0.936184692382812f,
                [94]  = 0.947361755371094f,
                [95]  = 0.958330078125f,
                [96]  = 0.969082336425781f,
                [97]  = 0.979611206054687f,
                [98]  = 0.989909362792969f,
                [99]  = 0.999969482421875f,
                [100] = 1.0060546875f,
            };

            public static float Get(int c)
            {
                if (Map.TryGetValue(c, out var value)) return value;

                return c >= 100 ? float.MaxValue : 0;
            }
        }
    }
}